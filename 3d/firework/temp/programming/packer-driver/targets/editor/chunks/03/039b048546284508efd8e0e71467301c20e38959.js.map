{"version":3,"sources":["file:///E:/personal/git/cocos-creator/3d/firework/assets/src/Roam.ts"],"names":["_decorator","Component","Input","input","KeyCode","NodeSpace","Node","v3","tween","ccclass","property","ERoamMode","EAxis","Roam","angleScale","moveScale","angle_temp","worldPos_temp","deltaMove_temp","followPosTarget","isFollowPos","relativeFollowPos","followAngleTarget","isFollowAngle","followAngle_temp","isRound","onLoad","addEvents","reset","test","window","node","console","log","forward","followTarget","repeatForever","to","position","start","set","update","dt","updateFollowPos","updateFollowAngle","on","EventType","TOUCH_MOVE","touchMove","TOUCH_END","touchEnd","MOUSE_WHEEL","mouseWheel","KEY_PRESSING","keyPressing","KEY_DOWN","keyDown","KEY_UP","keyUp","e","dx","getDeltaX","dy","getDeltaY","rotate","resumeFollowAngle","useKeyBoard","unUseKeyBoard","resumeFollowPos","keyCode","KEY_W","z","KEY_A","x","KEY_S","KEY_D","KEY_Q","y","KEY_Z","move","delta","getScrollY","pauseFollowAngle","old","eulerAngles","setRotationFromEuler","dir","pauseFollowPos","translate","LOCAL","followPos","target","pos","unFollowPos","getWorldPosition","add","setWorldPosition","followAngle","unFollowAngle","subtract","worldPosition","lookAt","roundSelf","axis","roundOther","distance"],"mappings":"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","sourcesContent":["import { _decorator, Component, EventKeyboard, EventMouse, EventTouch, Input, input, KeyCode, NodeSpace, Node, quat, Quat, v3, Vec2, Vec3, tween } from 'cc';\nconst { ccclass, property } = _decorator;\n\n/**漫游模式 */\nexport enum ERoamMode {\n    free,\n    follow,\n    round\n}\n\n/**三轴类型 */\nexport enum EAxis {\n    X,\n    Y,\n    Z\n}\n\n/**\n * 上下左右转头：鼠标移动\n * 上下左右移动：w s a d\n * 前后移动：鼠标滚轮\n */\n@ccclass('Roam')\nexport class Roam extends Component {\n    @property(Node)\n    followTarget: Node = null;\n\n    private angleScale: number = 0.05;\n    private moveScale: number = 0.05;\n    /**当前本地欧拉角 */\n    private angle_temp: Vec3 = v3();\n    /**当前世界坐标 */\n    private worldPos_temp: Vec3 = v3();\n    /**本地微量移动 */\n    private deltaMove_temp: Vec3 = v3();\n\n    //位置跟随\n    private followPosTarget: Node = null;\n    private isFollowPos: boolean = false;\n    private relativeFollowPos: Vec3 = v3();\n\n    //角度跟随\n    private followAngleTarget: Node = null;\n    private isFollowAngle: boolean = false;\n    private followAngle_temp: Vec3 = v3();\n\n    //环绕目标\n    private isRound: boolean = false;\n\n\n    protected onLoad(): void {\n        this.addEvents();\n        this.reset();\n\n        // this.test();\n    }\n\n    private test() {\n        window[`node`] = this.node;\n        console.log(`this.node.forward:`, this.node.forward);\n        tween(this.followTarget)\n            .repeatForever(tween()\n                .to(5, { position: v3(20, 0, 0) })\n                .to(5, { position: v3(-20, 0, 0) })\n            )\n            .start();\n\n        // this.followAngle(this.followTarget);\n        // this.followPos(this.followTarget);\n    }\n\n    private reset() {\n        this.followPosTarget = null;\n        this.isFollowPos = false;\n        this.relativeFollowPos.set(0, 0, 0);\n        this.followAngleTarget = null;\n        this.isFollowAngle = false;\n    }\n\n    protected update(dt: number): void {\n        if (this.isFollowPos && this.followPosTarget) this.updateFollowPos();\n        if (this.isFollowAngle && this.followAngleTarget) this.updateFollowAngle();\n    }\n\n    private addEvents() {\n        // input.on(Input.EventType.TOUCH_START, this.touchStart, this);\n        input.on(Input.EventType.TOUCH_MOVE, this.touchMove, this);\n        input.on(Input.EventType.TOUCH_END, this.touchEnd, this);\n        input.on(Input.EventType.MOUSE_WHEEL, this.mouseWheel, this);\n        input.on(Input.EventType.KEY_PRESSING, this.keyPressing, this);\n        input.on(Input.EventType.KEY_DOWN, this.keyDown, this);\n        input.on(Input.EventType.KEY_UP, this.keyUp, this);\n    }\n\n    private touchMove(e: EventTouch) {\n        const dx = e.getDeltaX() * this.angleScale,\n            dy = e.getDeltaY() * this.angleScale;\n        this.rotate(-dy, dx);\n    }\n\n    private touchEnd(e: EventTouch) {\n        if (this.followAngleTarget) this.resumeFollowAngle();\n    }\n\n    private keyPressing(e: EventKeyboard) {\n        this.useKeyBoard(e);\n    }\n\n    private keyDown(e: EventKeyboard) {\n        this.useKeyBoard(e);\n    }\n\n    private keyUp(e: EventKeyboard) {\n        this.unUseKeyBoard(e);\n        if (this.followPosTarget) this.resumeFollowPos();\n    }\n\n    /**触发键盘事件 */\n    private useKeyBoard(e: EventKeyboard) {\n        switch (e.keyCode) {\n            case KeyCode.KEY_W:\n                this.deltaMove_temp.z = -this.moveScale * 5;\n                break;\n            case KeyCode.KEY_A:\n                this.deltaMove_temp.x = -this.moveScale;\n                break;\n            case KeyCode.KEY_S:\n                this.deltaMove_temp.z = this.moveScale * 5;\n                break;\n            case KeyCode.KEY_D:\n                this.deltaMove_temp.x = this.moveScale;\n                break;\n            case KeyCode.KEY_Q://上\n                this.deltaMove_temp.y = this.moveScale;\n                break;\n            case KeyCode.KEY_Z://下\n                this.deltaMove_temp.y = -this.moveScale;\n                break;\n        }\n        this.move(this.deltaMove_temp);\n    }\n\n    /**结束键盘事件 */\n    private unUseKeyBoard(e: EventKeyboard) {\n        this.deltaMove_temp.set(0, 0, 0);\n    }\n\n    /**快速前后移动 */\n    private mouseWheel(e: EventMouse) {\n        let delta = e.getScrollY();\n        if (delta > 0) {\n            this.deltaMove_temp.z = -this.moveScale * 30;\n        } else {\n            this.deltaMove_temp.z = this.moveScale * 30;\n        }\n        this.move(this.deltaMove_temp);\n    }\n\n    /**四方向欧拉转向 */\n    private rotate(dx: number, dy: number) {\n        if (this.isFollowAngle) this.pauseFollowAngle();\n        const old = this.node.eulerAngles;\n        this.angle_temp.x = old.x + dx;\n        this.angle_temp.y = old.y + dy;\n        this.node.setRotationFromEuler(this.angle_temp);\n    }\n\n    /**六方向移动 */\n    private move(dir: Vec3) {\n        if (this.isFollowPos) this.pauseFollowPos();\n        this.node.translate(dir, NodeSpace.LOCAL);\n    }\n\n\n\n\n\n    /**位置跟随 pos: 相对目标位置*/\n    private followPos(target: Node, pos: Vec3 = v3(0, 0, 20)) {\n        this.followPosTarget = target;\n        this.isFollowPos = true;\n        this.relativeFollowPos.set(pos.x, pos.y, pos.z);\n    }\n    /**解除位置跟随 */\n    private unFollowPos() {\n        this.followPosTarget = null;\n        this.isFollowPos = false;\n    }\n    /**暂停 */\n    private pauseFollowPos() {\n        if (this.isFollowPos && this.followPosTarget)\n            this.isFollowPos = false;\n    }\n    /**恢复 */\n    private resumeFollowPos() {\n        if (!this.isFollowPos && this.followPosTarget)\n            this.isFollowPos = true;\n    }\n    private updateFollowPos() {\n        this.followPosTarget.getWorldPosition(this.worldPos_temp);\n        this.worldPos_temp.add(this.relativeFollowPos);\n        this.node.setWorldPosition(this.worldPos_temp);\n    }\n\n\n\n    /**角度跟随 */\n    private followAngle(target: Node) {\n        this.followAngleTarget = target;\n        this.isFollowAngle = true;\n    }\n    /**解除角度跟随 */\n    private unFollowAngle(target: Node) {\n        this.followAngleTarget = null;\n        this.isFollowAngle = false;\n    }\n    /**暂停 */\n    private pauseFollowAngle() {\n        if (this.isFollowAngle && this.followAngleTarget)\n            this.isFollowAngle = false;\n    }\n    /**恢复 */\n    private resumeFollowAngle() {\n        if (!this.isFollowAngle && this.followAngleTarget)\n            this.isFollowAngle = true;\n    }\n    private updateFollowAngle() {\n        this.followAngleTarget.getWorldPosition(this.followAngle_temp);\n        this.followAngle_temp.subtract(this.node.worldPosition);\n        this.node.lookAt(this.followAngle_temp);\n    }\n\n\n\n    /**自身环绕 */\n    private roundSelf(axis: EAxis) {\n\n    }\n\n    /**环绕其他目标 */\n    private roundOther(target: Node, axis: EAxis, distance: number = 10) {\n        this.followAngle(target);\n        if (this.isFollowPos || this.followPosTarget) this.unFollowPos();\n        // this.node.pos\n\n    }\n}\n\n"]}