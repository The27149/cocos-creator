{"version":3,"sources":["file:///E:/personal/bezier-viewer/assets/scripts/Paper.ts"],"names":["_decorator","Component","Node","Prefab","Sprite","Color","UITransform","v3","v2","CCFloat","Graphics","Label","director","Canvas","NodeEventType","NodeFactory","Point","ccclass","property","Paper","canvasNode","pointPool","pointNum","ctrlPoints","stageMultiList","onLoad","getScene","getComponentInChildren","node","addEvents","pointPre","init","randomDraw","on","TOUCH_MOVE","onTouchMove","MOUSE_WHEEL","onMouseWheel","removeEvents","off","e","delta","touch","getDelta","position","add3f","x","y","console","log","getScrollX","getScrollY","stage","i","Math","round","random","push","draw","min","max","updateCtrls","length","ctrlContainer","children","p","drawCtrls","ctrls","n","len","t","item","ctrl","j","comb","pow","drawLines","putNode","getNode","parent","ui","getComponent","width","height","lineWidth","color","YELLOW","setPosition","getChildByName","string","g","graphicsContainer","clear","moveTo","lineTo","stroke","stageMulti","num","res"],"mappings":"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","sourcesContent":["import { _decorator, Component, Node, Prefab, Vec2, Sprite, Color, ColorKey, color, UITransform, Vec3, v3, v2, CCFloat, Graphics, Label, find, director, Canvas, NodeEventType, EventTouch, EventMouse } from 'cc';\nimport NodeFactory from './NodeFactory';\nimport { Point } from './Point';\nconst { ccclass, property } = _decorator;\n\n@ccclass('Paper')\nexport class Paper extends Component {\n\n    @property(Prefab)\n    pointPre: Prefab = null;\n\n    @property(Color)\n    lineColor: Color = null;\n\n    @property(CCFloat)\n    lineWidth: number = 5;\n\n    @property(Node)\n    lineContainer: Node = null;\n\n    @property(Node)\n    ctrlContainer: Node = null;\n\n    @property(Node)\n    graphicsContainer: Node = null;\n\n    private canvasNode: Node = null;\n\n    private pointPool: NodeFactory = null;\n    private pointNum: number = 1000;\n    /**所有控制点坐标 */\n    private ctrlPoints: Vec2[] = [];\n\n    onLoad() {\n        this.canvasNode = director.getScene().getComponentInChildren(Canvas).node;\n        this.addEvents();\n        this.pointPool = new NodeFactory(this.pointPre);\n        this.pointPool.init(this.pointNum);\n        this.randomDraw(3);\n    }\n\n    private addEvents() {\n        this.canvasNode.on(NodeEventType.TOUCH_MOVE, this.onTouchMove, this);\n        this.canvasNode.on(NodeEventType.MOUSE_WHEEL, this.onMouseWheel, this);\n    }\n\n    private removeEvents() {\n        this.canvasNode.off(NodeEventType.TOUCH_MOVE, this.onTouchMove, this);\n        this.canvasNode.off(NodeEventType.MOUSE_WHEEL, this.onMouseWheel, this);\n    }\n\n    private onTouchMove(e: EventTouch) {\n        let delta = e.touch.getDelta();\n        this.node.position = this.node.position.add3f(delta.x, delta.y, 0);\n    }\n\n    private onMouseWheel(e: EventMouse) {\n        // let long = e.getScrollX\n        console.log('滚动：', e.getScrollX(), e.getScrollY());\n    }\n\n    private randomDraw(stage: number = 3) {\n        for (let i = 0; i < stage + 1; i++) {\n            let x = Math.round(this.random(-960, 960));\n            let y = Math.round(this.random(-540, 540));\n            this.ctrlPoints.push(v2(x, y));\n        }\n        this.draw();\n    }\n\n    private random(min: number, max: number): number {\n        return Math.random() * (max - min) + min;\n    }\n\n    /**控制点更新后 重绘曲线 */\n    public updateCtrls() {\n        this.ctrlPoints.length = this.ctrlContainer.children.length;\n        for (let i = 0; i < this.ctrlPoints.length; i++) {\n            let node = this.ctrlContainer.children[i];\n            let p = this.ctrlPoints[i];\n            if (!p) p = v2();\n            p.x = node.position.x;\n            p.y = node.position.y;\n            this.ctrlPoints[i] = p;\n        }\n        this.draw();\n    }\n\n    public draw() {\n        this.drawCtrls();\n        let ctrls = this.ctrlPoints;\n        //计算路径坐标\n        let n = ctrls.length - 1;\n        for (let i = 0, len = this.pointNum; i < len; i++) {\n            let t = i / len, x = 0, y = 0;\n            let item: number, ctrl: Vec2;\n            for (let j = 0; j < n + 1; j++) {\n                item = this.comb(n, j) * Math.pow(1 - t, n - j) * Math.pow(t, j);\n                ctrl = ctrls[j];\n                x += ctrl.x * item;\n                y += ctrl.y * item;\n            }\n            // this.line1(x, y, i);\n            this.drawLines(x, y, i);\n        }\n    }\n\n\n    // /**方式1： 点累积成线 */\n    // private line1(x: number, y: number, i: number) {\n    //     this.lineContainer.children.forEach(child => { this.pointPool.putNode(child) });\n    //     let node = this.lineContainer.children[i];\n    //     if (!node) {\n    //         node = this.pointPool.getNode();\n    //         node.parent = this.lineContainer;\n    //     }\n    //     node.getComponent(Sprite).color = this.lineColor;\n    //     let ui = node.getComponent(UITransform);\n    //     ui.width = ui.height = this.lineWidth;\n    //     node.setPosition(v3(x, y));\n    // }\n\n    /**绘制控制点*/\n    private drawCtrls() {\n        //如果有多余的点 先回收\n        if (this.ctrlContainer.children.length > this.ctrlPoints.length) {\n            for (let j = this.ctrlPoints.length; j < this.ctrlContainer.children.length; j++) {\n                let node = this.ctrlContainer.children[j];\n                this.pointPool.putNode(node);\n            }\n        }\n        for (let i = 0; i < this.ctrlPoints.length; i++) {\n            let p = this.ctrlContainer.children[i];\n            if (!p) {\n                p = this.pointPool.getNode();\n                p.parent = this.ctrlContainer;\n                let ui = p.getComponent(UITransform);\n                ui.width = ui.height = this.lineWidth * 3;\n                p.getComponent(Sprite).color = Color.YELLOW;\n                p.getComponent(Point).init(this);\n            }\n            let x = this.ctrlPoints[i].x, y = this.ctrlPoints[i].y;\n            p.setPosition(v3(x, y));\n            p.getChildByName('coordinate').getComponent(Label).string = `P${i}(x:${x}, y:${y})`;\n        }\n    }\n\n    /**方式2： canvas2d绘制 */\n    private drawLines(x: number, y: number, i: number) {\n        let g = this.graphicsContainer.getComponent(Graphics);\n        if (i === 0) {\n            g.clear();\n            g.moveTo(x, y);\n        } else g.lineTo(x, y);\n        if (i === this.pointNum - 1) g.stroke();\n    }\n\n    // private ctrls2() {\n    //     let g = this.graphicsContainer.getComponent(Graphics);\n    //     let ctrls = this.ctrlPoints;\n    //     for (let k = 0; k < ctrls.length; k++) {\n    //         g.circle(ctrls[k].x, ctrls[k].y, this.lineWidth * 1.5);\n    //         g.fillColor = Color.YELLOW;\n    //         g.fill();\n\n    //     }\n    // }\n\n    /**计算阶乘 */\n    private stageMultiList: number[] = [1, 1, 2, 6, 24, 120, 720, 5040, 40320, 362880, 3628800];\n    private stageMulti(num: number): number {\n        let res = this.stageMultiList[num];\n        if (!res) {\n            res = num * this.stageMulti(num - 1);\n            this.stageMultiList[num] = res;\n        }\n        return res;\n    }\n\n    /** 计算组合数 */\n    private comb(n: number, i: number): number {\n        return this.stageMulti(n) / this.stageMulti(i) / this.stageMulti(n - i);\n    }\n}\n\n"]}